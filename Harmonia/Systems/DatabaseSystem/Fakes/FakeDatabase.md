# FakeDatabase

Simulates a database for testing purposes.

This class mimics the behavior of `Database` without requiring an actual
database connection. It allows tests to define expected SQL queries, their
parameter bindings, and the results to be returned.

#### Example
```php
use \Harmonia\Systems\DatabaseSystem\Fakes\FakeDatabase;
use \Harmonia\Systems\DatabaseSystem\Database;
use \Peneus\Model\Account;

class AccountTest extends \PHPUnit\Framework\TestCase
{
    function testIsRegistered()
    {
        $fakeDatabase = new FakeDatabase();
        $fakeDatabase->Expect(
            sql: 'SELECT COUNT(*) FROM `account` WHERE `email` = :email',
            bindings: ['email' => 'john@example.com'],
            result: [[1]]
        );
        Database::ReplaceInstance($fakeDatabase);

        $count = Account::Count(
            condition: 'email = :email',
            bindings: ['email' => 'john@example.com']
        );
        $this->assertSame(1, $count);
    }
}
```

## Methods

### __construct

Constructs a new instance.

This constructor overrides the protected base constructor inherited from
the singleton, allowing the class to be instantiated with `new` in test
code.

#### Syntax

```php
public function __construct()
```

---

### Expect

Defines a query expectation.

This method registers an expected SQL query with its associated parameter
bindings and return behavior. When `Execute` is later called with a
matching query and bindings, the configured result will be returned.

#### Syntax

```php
public function Expect(string $sql, array<string,mixed> $bindings = [], ?array<int,array<string,mixed>> $result = [], int $lastInsertId = 0, int $lastAffectedRowCount = 0, ?int $times = self::UNLIMITED_TIMES): void
```

#### Parameters

- **$sql**: The SQL query string to match against during execution. Placeholders (e.g., `:email`) must be used instead of literal values, and must correspond to the binding keys.
- **$bindings**: The expected parameter bindings for the query. Keys must match the SQL placeholders without the colon (e.g., `'email' => 'john@example.com'` for `:email` in SQL).
- **$result**: (Optional) The result rows to return from the query. Each row must be an associative array with column names as keys. If `null`, the query will return `null` to simulate failure. Defaults to an empty array.
- **$lastInsertId**: (Optional) The value to be returned from `LastInsertId` after the query is executed. Defaults to `0`, simulating no last insert ID.
- **$lastAffectedRowCount**: (Optional) The value to be returned from `LastAffectedRowCount` after the query is executed. Use `-1` to simulate a query failure. Defaults to `0`, indicating no rows were affected.
- **$times**: (Optional) The number of times this expectation may be matched. If set to a positive integer, the expectation will only match that many times; exceeding it will throw an exception. If `null`, the expectation may be matched unlimited times.

---

### VerifyAllExpectationsMet

Verifies that all expectations were fully consumed.

#### Syntax

```php
public function VerifyAllExpectationsMet(): void
```

#### Exceptions

- **\RuntimeException**: If any expectation was not matched the required number of times.

---

### Execute

Simulates query execution and returns a configured result.

This method matches the given query and bindings against expectations
registered via `Expect`. If a match is found, it returns a `FakeResultSet`
or `null` (if configured). If no matching expectation exists, or if the
expectation has already been used the maximum number of allowed times, an
exception is thrown.

#### Syntax

```php
public function Execute(\Harmonia\Systems\DatabaseSystem\Queries\Query $query): ?\Harmonia\Systems\DatabaseSystem\ResultSet
```

#### Parameters

- **$query**: The query object containing the SQL and its bound parameters.

#### Return Value

A simulated result set based on the configured expectation, or `null` if the expectation result was explicitly set to `null`.

#### Exceptions

- **\RuntimeException**: If no matching expectation is found, or if the expectation has been exhausted.

---

### LastInsertId

Returns the simulated ID generated by the last `INSERT` query.

#### Syntax

```php
public function LastInsertId(): int
```

#### Return Value

The last insert ID. Defaults to `0` if not explicitly configured.

---

### LastAffectedRowCount

Returns the simulated number of affected rows by the last `UPDATE` or
`DELETE` query.

#### Syntax

```php
public function LastAffectedRowCount(): int
```

#### Return Value

The number of affected rows. Defaults to `0`, indicating that no rows were affected. Use `-1` to simulate a failed query.

---

### WithTransaction

Simulates a database transaction block.

The callback is invoked immediately without starting a real transaction.

#### Syntax

```php
public function WithTransaction(callable $callback): void
```

#### Parameters

- **$callback**: The callback function to execute. It may throw an exception to signal an error.

#### Exceptions

- **\Throwable**: If the callback throws an exception.

---

### EscapeString

Simulates MySQL's `real_escape_string()` behavior.

Unlike the real method, this simulation does not account for connection
charset or collation. However, it closely approximates the escaping
behavior for testing purposes.

#### Syntax

```php
public function EscapeString(string $string): string
```

#### Parameters

- **$string**: The input string to escape.

#### Return Value

A simulated escaped string.

---

*This documentation was automatically generated using [phpDocumentor](http://www.phpdoc.org/) with the [Calliope](https://github.com/DaphneWebFramework/Calliope) template.*
